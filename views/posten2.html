<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Escape Room: Die verschwundene PrÃ¼fung</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    :root {
      --panel-bg: rgba(44,62,80,0.85);
      --text: #ecf0f1;
      --muted: #bdc3c7;
      --accent: #e67e22;
      --accent-hover: #d35400;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html { height: 100%; }
    body {
      margin: 0;
      min-height: 100svh;
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      padding: max(1rem, env(safe-area-inset-top)) max(1rem, env(safe-area-inset-right)) max(1rem, env(safe-area-inset-bottom)) max(1rem, env(safe-area-inset-left));
      display: grid;
      place-items: center;
    }
    header { text-align: center; margin-bottom: 0.5rem; font-weight: 600; font-size: clamp(1rem, 2.5vw, 1.25rem); }
    main {
      width: min(92vw, 560px);
      background: var(--panel-bg);
      border-radius: 12px;
      padding: clamp(1rem, 3vw, 1.5rem);
      backdrop-filter: saturate(1.1) blur(3px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    h1 { margin: 0 0 .75rem; font-size: clamp(1.4rem, 3.5vw, 2rem); line-height: 1.2; }
    p { color: var(--muted); }
    code { display: inline-block; padding: .25rem .4rem; border-radius: 6px; background: rgba(0,0,0,.25); }
    #answer { width: 100%; padding: .85rem 1rem; border: none; border-radius: 8px; font-size: 1rem; margin: .5rem 0 0.75rem; }
    #validateButton, #nextButton { width: 100%; padding: .9rem 1rem; border: none; border-radius: 10px; font-size: 1.05rem; cursor: pointer; transition: transform .06s ease, background .2s ease; }
    #validateButton { background: var(--accent); color: #fff; }
    #validateButton:hover { background: var(--accent-hover); }
    #validateButton:active { transform: translateY(1px); }
    #nextButton { margin-top: .5rem; background: rgba(255,255,255,.1); color: #fff; }
    @media (max-height: 480px) and (orientation: landscape) {
      body { padding: .5rem; }
      main { padding: 1rem; }
    }
  </style>
</head>
<body>
  <header>Escape Room: Die verschwundene PrÃ¼fung</header>
  <main>
    <h1>Posten 2</h1>
    <p>
      EntschlÃ¼ssele den folgenden Morsecode und gib das Ergebnis als Wort ein.<br><br>
      <code style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; font-size: 1.05rem;">âˆ’âˆ’âˆ’ âˆ’âˆ’ Â·Â·Â·  /  âˆ’Â·Â·Â· Â·âˆ’Â· Â·Â· âˆ’âˆ’Â·</code><br><br>
      <span style="font-size:0.9rem;color:#bdc3c7;">Hinweis: Das Symbol <code>/</code> steht fÃ¼r ein Leerzeichen. Bitte alles in Kleinbuchstaben schreiben.</span>
    </p>
    <input type="text" id="answer" placeholder="Antwort">
    <button id="validateButton" onclick="checkAnswer()">BestÃ¤tigen</button>
    <button id="nextButton" hidden>Posten 3</button>
    <p id="message"></p>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script>
    let attempts = 0;
    const maxAttempts = 3;
    const lockDuration = 15000; // 15 secondes
    const nextButton = document.getElementById('nextButton');
    nextButton.addEventListener('click', () => {
      window.location.href = '/posten3';
    });

    function checkAnswer() {
      const answer = document.getElementById('answer').value;
      const message = document.getElementById('message');
      const button = document.getElementById('validateButton');

      if (attempts >= maxAttempts) {
        message.textContent = "Sie sind gesperrt. Bitte warten Sie 15 Sekunden...";
        return;
      }

      const normalized = answer.toLowerCase().trim().replace(/\s+/g, ' ');
      if (normalized === "oms brig") {
        message.textContent = "âœ… Bravo! Deine LÃ¶sung ist: oms brig";
        message.style.color = "lightgreen";
        document.getElementById('answer').disabled = true;
        button.disabled = true;

        // Lancer lâ€™animation confetti
        confetti({ particleCount: 200, spread: 80 });

        // Attendre la confetti puis notifier le serveur et afficher le bouton Suivant
        setTimeout(() => {
          fetch('/progress/posten2', {
            method: 'POST',
            credentials: 'include'    // <-- force lâ€™envoi des cookies de session
            })
            .then(res => {
              console.log('POST /progress/posten2 â†’', res.status);
              if (!res.ok) throw new Error('Ã‰chec enregistrement progrÃ¨s');
              return res.json();
            })
            .then(() => nextButton.hidden = false)
            .catch(err => {
              console.error(err);
              message.textContent = 'Erreur interne, rÃ©essayez';
            });
        }, 2000);
        
      } else {
        attempts++;
        if (attempts >= maxAttempts) {
          message.textContent = "ðŸš« Zu viele Fehler! FÃ¼r 15 Sekunden gesperrt.";
          message.style.color = "red";
          button.disabled = true;
          setTimeout(() => {
            attempts = 0;
            message.textContent = "Sie kÃ¶nnen es noch einmal versuchen.";
            button.disabled = false;
          }, lockDuration);
        } else {
          message.textContent = `Eine falsche Antwort. Versuch ${attempts}/${maxAttempts}.`;
          message.style.color = "orange";
        }
      }
    }

    setInterval(() => {
    fetch('/api/status')
      .then(res => res.json())
      .then(data => {
        if (data.timeLeft !== null && data.timeLeft <= 0) {
          window.location.href = '/results';
        }
      });
  }, 3000);
  </script>
</body>
</html>