<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Escape Room: Die verschwundene Pr√ºfung</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    :root{
      --panel-bg: rgba(44,62,80,0.85);
      --text:#ecf0f1; --muted:#bdc3c7; --accent:#e67e22; --accent-hover:#d35400;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html{ height:100%; }
    body{ margin:0; min-height:100svh; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; display:grid; place-items:center; padding:max(1rem, env(safe-area-inset-top)) max(1rem, env(safe-area-inset-right)) max(1rem, env(safe-area-inset-bottom)) max(1rem, env(safe-area-inset-left)); }
    header{ text-align:center; margin-bottom:.5rem; font-weight:600; font-size:clamp(1rem,2.5vw,1.25rem); }
    main{ width:min(92vw,560px); background:var(--panel-bg); border-radius:12px; padding:clamp(1rem,3vw,1.5rem); backdrop-filter:saturate(1.1) blur(3px); box-shadow:0 8px 16px rgba(0,0,0,.3); }
    h1{ margin:0 0 .75rem; font-size:clamp(1.4rem,3.5vw,2rem); line-height:1.2; }
    .story p, .story li, .story blockquote{ color:var(--muted); }
    ol{ padding-left: 1.1rem; }
    code, kbd { display:inline-block; padding:.1rem .35rem; border-radius:6px; background:rgba(0,0,0,.25); }
    #answer{ width:100%; padding:.85rem 1rem; border:2px solid #000; border-radius:8px; font-size:1rem; margin:.5rem 0 .75rem; background:#636363; color:#000; }
    #validateButton{ width:100%; padding:.9rem 1rem; border:2px solid #000; border-radius:10px; font-size:1.05rem; cursor:pointer; transition:transform .06s ease, background .2s ease; background:var(--accent); color:#ffffff; }
    #validateButton:hover{ background:var(--accent-hover); }
    #validateButton:active{ transform:translateY(1px); }
    /* Simple modal */
    .modal{ position: fixed; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,.55); z-index: 50; }
    .modal[hidden]{ display: none; }
    .modal__dialog{ width: min(92vw, 480px); background: var(--panel-bg); color: var(--text); border-radius: 12px; padding: clamp(1rem, 3vw, 1.5rem); text-align: center; box-shadow: 0 12px 24px rgba(0,0,0,.4); backdrop-filter: saturate(1.1) blur(4px); }
    .modal__title{ margin: 0 0 .5rem; font-size: clamp(1.25rem, 3vw, 1.6rem); }
    .modal__text{ margin: 0 0 1rem; color: var(--muted); }
    .modal__btn{ display: inline-block; margin-top: .25rem; padding: .8rem 1rem; border: 2px solid #000; border-radius: 10px; background: var(--accent); color: #000; font-weight: 600; cursor: pointer; }
    @media (max-height:480px) and (orientation:landscape){ body{ padding:.5rem; } main{ padding:1rem; } }
  </style>
</head>
<body>
  <header>Escape Room: Die verschwundene Pr√ºfung</header>
  <main>
    <h1>Posten 4</h1>
    <section class="story" data-aos="fade-up">
      <p>L√∂se die folgenden Gleichungen und bilde aus den Ergebnissen (in der Reihenfolge x, y, z, t) einen vierstelligen Code:</p>
      <ol>
        <li><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mn>2</mn><mi>x</mi><mo>+</mo><mn>4</mn><mo>=</mo><mn>6</mn></mrow></math></li>
        <li><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mn>3</mn><mi>y</mi><mo>‚àí</mo><mn>4</mn><mo>=</mo><mn>11</mn></mrow></math></li>
        <li><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mi>z</mi><mo>/</mo><mn>3</mn><mo>+</mo><mn>2</mn><mo>=</mo><mn>5</mn></mrow></math></li>
        <li><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mn>2</mn><mo>(</mo><mi>t</mi><mo>‚àí</mo><mn>3</mn><mo>)</mo><mo>=</mo><mn>8</mn></mrow></math></li>
      </ol>
      <p style="font-size:0.9rem;color:#bdc3c7;">Hinweis: Bitte nur die vier Ziffern eingeben.</p>
    </section>  
    <input type="text" id="answer" placeholder="Antwort (4-stelliger Code)">
    <button id="validateButton" onclick="checkAnswer()">Best√§tigen</button>
    <p id="message"></p>
    <div id="winModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="winTitle" hidden>
      <div class="modal__dialog">
        <h2 id="winTitle" class="modal__title">üéâ Gl√ºckwunsch!</h2>
        <p class="modal__text">Ihr habt alle R√§tsel gel√∂st. Gro√üartige Arbeit!</p>
        <button id="closeWinModal" class="modal__btn" type="button">Schlie√üen</button>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script>
    let attempts = 0;
    const maxAttempts = 3;
    const lockDuration = 15000; // 15 secondes

    function checkAnswer() {
      const answer = document.getElementById('answer').value;
      const message = document.getElementById('message');
      const button = document.getElementById('validateButton');

      if (attempts >= maxAttempts) {
        message.textContent = "Sie sind gesperrt. Bitte warten Sie 15 Sekunden...";
        return;
      }

      const normalized = answer.replace(/[^\d]/g, '').trim();
      if (normalized === "5597") {
        message.textContent = "‚úÖ Gl√ºckwunsch! Der Code ist korrekt: 5597";
        message.style.color = "lightgreen";
        document.getElementById('answer').disabled = true;
        button.disabled = true;

        // Konfetti-Animation
        confetti({ particleCount: 200, spread: 80 });

        // Nach der Animation: Fortschritt speichern und Ergebnisse anzeigen
        setTimeout(() => {
          fetch('/progress/posten4', {
            method: 'POST',
            credentials: 'include'
          })
          .then(res => {
            console.log('POST /progress/posten4 ‚Üí', res.status);
            if (!res.ok) throw new Error('√âchec enregistrement progr√®s');
            return res.json();
          })
          .then(() => {
            const modal = document.getElementById('winModal');
            if (modal) modal.hidden = false;
            document.getElementById('closeWinModal')?.addEventListener('click', () => {
              modal.hidden = true;
            });
          })
          .catch(err => {
            console.error(err);
            message.textContent = 'Erreur interne, r√©essayez';
          });
        }, 2000);
        
      } else {
        attempts++;
        if (attempts >= maxAttempts) {
          message.textContent = "üö´ Zu viele Fehler! F√ºr 15 Sekunden gesperrt.";
          message.style.color = "red";
          button.disabled = true;
          setTimeout(() => {
            attempts = 0;
            message.textContent = "Sie k√∂nnen es noch einmal versuchen.";
            button.disabled = false;
          }, lockDuration);
        } else {
          message.textContent = `Eine falsche Antwort. Versuch ${attempts}/${maxAttempts}.`;
          message.style.color = "orange";
        }
      }
    }

    setInterval(() => {
    fetch('/api/status')
      .then(res => res.json())
      .then(data => {
        if (data.timeLeft !== null && data.timeLeft <= 0) {
          window.location.href = '/results';
        }
      });
  }, 3000);
  </script>
</body>
</html>