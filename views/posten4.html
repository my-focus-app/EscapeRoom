<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Escape Room: Die verschwundene PrÃ¼fung</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header>Escape Room: Die verschwundene PrÃ¼fung</header>
  <main>
    <h1>Posten 4</h1>
    <section class="story" data-aos="fade-up">
      <p>Ihr betretet das BÃ¼ro des Rektors. Auf seinem Schreibtisch liegt ein altes Dokument mit folgendem Hinweis:</p>
      <blockquote>â€žDie PrÃ¼fung ist hinter der Logik ihrer eigenen Fragen verborgen. Nur wer den Abschlusstest besteht, findet den Code.â€œ</blockquote>
      <p>Ihr entdeckt das folgende PrÃ¼fungsblatt mit Multiple-Choice-Fragen. Nur eine einzige Kombination ist korrekt â€“ jede richtige Antwort ergibt eine Zahl.</p>
      <ol>
        <li><strong>Welche Aussage ist wahr?</strong><br>
          A. Zwei der Antworten sind korrekt.<br>
          B. Diese Antwort ist falsch.<br>
          C. Alle Antworten sind falsch.
        </li>
        <li><strong>Wenn eine Aussage falsch ist, welche ist es?</strong><br>
          A. Diese Antwort ist falsch.<br>
          B. A ist wahr.<br>
          C. Beide vorherigen Antworten sind falsch.
        </li>
        <li><strong>Welcher Zahlenwert ergibt sich fÃ¼r das Wort â€žPRÃœFUNGâ€œ, wenn A=1, B=2 ... Z=26?</strong><br>
          A. 111<br>
          B. 115<br>
          C. 118
        </li>
        <li><strong>Wie oft kommt der Buchstabe E in diesem Text vor?</strong><br>
          A. 7<br>
          B. 11<br>
          C. 13
        </li>
      </ol>
      <p><strong>Hinweis:</strong> Verwandle die Buchstaben deiner Antworten (z.â€¯B. â€žABCAâ€œ) in Zahlen gemÃ¤ÃŸ:<br>
      A = 1, B = 2, C = 3</p>
    </section>  
    <input type="text" id="answer" placeholder="123">
    <button id="validateButton" onclick="checkAnswer()">BestÃ¤tigen</button>
    <button id="nextButton" hidden>Fertig</button>
    <p id="message"></p>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script>
    let attempts = 0;
    const maxAttempts = 3;
    const lockDuration = 15000; // 15 secondes
    const nextButton = document.getElementById('nextButton');
    nextButton.addEventListener('click', () => {
      window.location.href = '/';
    });

    function checkAnswer() {
      const answer = document.getElementById('answer').value;
      const message = document.getElementById('message');
      const button = document.getElementById('validateButton');

      if (attempts >= maxAttempts) {
        message.textContent = "Sie sind gesperrt. Bitte warten Sie 15 Sekunden...";
        return;
      }

      if (answer.trim() === "2312") {
        message.textContent = "âœ… GlÃ¼ckwunsch! Der Code ist korrekt: 2312";
        message.style.color = "lightgreen";
        document.getElementById('answer').disabled = true;
        button.disabled = true;

        // Lancer lâ€™animation confetti
        confetti({ particleCount: 200, spread: 80 });

        // Attendre la confetti puis notifier le serveur et afficher le bouton Suivant
        setTimeout(() => {
          fetch('/progress/posten4', {
            method: 'POST',
            credentials: 'include'    // <-- force lâ€™envoi des cookies de session
            })
            .then(res => {
              console.log('POST /progress/posten1 â†’', res.status);
              if (!res.ok) throw new Error('Ã‰chec enregistrement progrÃ¨s');
              return res.json();
            })
            .then(() => nextButton.hidden = false)
            .catch(err => {
              console.error(err);
              message.textContent = 'Erreur interne, rÃ©essayez';
            });
        }, 2000);
        
      } else {
        attempts++;
        if (attempts >= maxAttempts) {
          message.textContent = "ðŸš« Zu viele Fehler! FÃ¼r 15 Sekunden gesperrt.";
          message.style.color = "red";
          button.disabled = true;
          setTimeout(() => {
            attempts = 0;
            message.textContent = "Sie kÃ¶nnen es noch einmal versuchen.";
            button.disabled = false;
          }, lockDuration);
        } else {
          message.textContent = `Eine falsche Antwort. Versuch ${attempts}/${maxAttempts}.`;
          message.style.color = "orange";
        }
      }
    }

    setInterval(() => {
    fetch('/api/status')
      .then(res => res.json())
      .then(data => {
        if (data.timeLeft !== null && data.timeLeft <= 0) {
          window.location.href = '/results';
        }
      });
  }, 3000);
  </script>
</body>
</html>